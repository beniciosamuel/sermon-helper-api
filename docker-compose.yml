version: '3.8'

name: kerygma

# Docker Compose: Backend and Frontend only (no Postgres or Metabase).
# Database must be provided via DATABASE_URL or DB_* env vars (e.g. .env).

services:
  backend:
    build:
      context: ./server
      dockerfile: Dockerfile
    container_name: kerygma-backend
    restart: unless-stopped
    ports:
      - '3000:3000'
    environment:
      NODE_ENV: production
      PORT: 3000
      DATABASE_URL: ${DATABASE_URL}
      SERVER_PORT: ${SERVER_PORT:-3000}
      CORS_ORIGIN: ${CORS_ORIGIN:-http://localhost:4000}
      # Google Cloud Secret Manager configuration
      GCP_PROJECT_ID: ${GCP_PROJECT_ID}
      GCP_SECRET_NAME: ${GCP_SECRET_NAME:-kerygma_server}
      GOOGLE_APPLICATION_CREDENTIALS: ${GOOGLE_APPLICATION_CREDENTIALS:-/app/gcp-credentials.json}
    volumes:
      # Mount Google Cloud service account key file (optional)
      # Set GCP_CREDENTIALS_PATH in your .env file or environment
      # Example: GCP_CREDENTIALS_PATH=./path/to/service-account-key.json
      - ${GCP_CREDENTIALS_PATH:-./gcp-credentials.json}:/app/gcp-credentials.json:ro
    networks:
      - kerygma-network
    healthcheck:
      test:
        [
          'CMD',
          'node',
          '-e',
          "require('http').get('http://localhost:3000/health', (r) => {process.exit(r.statusCode === 200 ? 0 : 1)})",
        ]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 30s

  frontend:
    build:
      context: ./client
      dockerfile: Dockerfile
      args:
        REACT_APP_API_URL: ${REACT_APP_API_URL:-http://localhost:3000}
    container_name: kerygma-frontend
    restart: unless-stopped
    ports:
      - '4000:5000'
    environment:
      NODE_ENV: production
      REACT_APP_API_URL: ${REACT_APP_API_URL:-http://localhost:3000}
      REACT_APP_WS_URL: ${REACT_APP_WS_URL:-http://localhost:3000}
    depends_on:
      - backend
    networks:
      - kerygma-network
    healthcheck:
      test: ['CMD', 'wget', '--quiet', '--tries=1', '--spider', 'http://localhost:5000']
      interval: 30s
      timeout: 10s
      retries: 3

networks:
  kerygma-network:
    driver: bridge
